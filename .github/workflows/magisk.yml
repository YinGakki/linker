name: Fully Static Linking Attempt (Musl)

'on':
  workflow_dispatch:
    inputs:
      version:
        description: 'Linker version tag'
        required: true
        default: 'v1.9.6'

jobs:
  static_build:
    runs-on: ubuntu-latest
    
    # 使用 Alpine Docker 容器进行构建，确保 Musl 环境
    container: 
      image: 'mcr.microsoft.com/dotnet/sdk:8.0-alpine-arm64v8' # 使用 MS 官方的 Alpine ARM64 SDK 镜像
      options: --user root # 确保有权限安装依赖和执行

    steps:
      - uses: actions/checkout@v4

      # 1. 安装构建所需的额外依赖
      - name: Install Build Dependencies (Alpine)
        run: |
          # Alpine 使用 apk 包管理器。安装 zlib-dev 和 g++ 以确保静态链接所需文件存在
          apk update
          apk add build-base zlib-dev

      # 2. 核心程序构建 - 最大化静态链接
      - name: Publish Musl ARM64 Static Executable
        run: |
          # 确保环境变量，有时需要在 dotnet 内部设置，但我们依赖 Musl SDK 镜像
          
          # 使用 Musl RID 和自包含发布。
          # 核心程序在 Musl SDK 容器内构建，天然使用 ld-musl 链接器。
          # 尝试通过附加参数 `-p:LinkerFlags` 强制进行 C++ 依赖的静态链接。
          # 注意：LinkerFlags 在 msbuild/dotnet 中设置复杂，这里的参数是通用尝试。
          # 对于 libstdc++，我们使用 -static-libstdc++ 尝试解决您之前的 'symbol not found' 问题。
          dotnet publish src/linker -c Release -f net8.0 -o /app/publish \
            -r linux-musl-arm64 \
            -p:PublishSingleFile=true \
            --self-contained true \
            -p:InvariantGlobalization=true \
            -p:TrimMode=partial \
            # 尝试解决 libstdc++ 依赖
            -p:ExtraLinkerFlags="-static-libstdc++" 
            
      # 3. 检查并打包最终产物
      - name: Check and Package Static Binary
        # 退出容器的 /app 目录，访问宿主机工作区
        shell: bash
        run: |
          # 复制到宿主机工作区
          cp /app/publish/linker ./linker-static
          
          # 检查链接情况 (在宿主机上使用 file 和 ldd 命令，假设宿主机是 Ubuntu)
          # 注意：ldd 在 Musl 静态文件上可能显示 'not a dynamic executable'，这是成功的标志
          echo "Checking linker binary details:"
          file ./linker-static
          
          # 压缩最终文件
          tar -czvf linker-static-${{ github.event.inputs.version }}.tar.gz linker-static
          
      # 4. 上传产物
      - name: Upload Static Package
        uses: actions/upload-artifact@v4
        with:
          name: linker-static-musl-package
          path: linker-static-${{ github.event.inputs.version }}.tar.gz
