# 工作流名称：Magisk 模块自动发布 (Linker + Rurima-AIO 集成)
name: Magisk Module Build and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version (e.g., v1.0.0) - REQUIRED for manual runs.'
        required: true
        default: 'v-manual-build'

jobs:
  build_module:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
        
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: 3. Compile Linker (Self-Contained Single File for ARM64)
        run: |
          dotnet publish src/linker \
            -c Release \
            -f net8.0 \
            -r linux-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o ./linker_output
            
      - name: 4. Download Latest Rurima-AIO Template (FIXED for .tar)
        id: get_rurima_release
        run: |
          echo "Fetching latest Rurima-AIO release URL..."
          
          JSON_RESPONSE=$(curl -sfL https://api.github.com/repos/RuriOSS/rurima-aio/releases/latest)
          
          echo "--- Rurima-AIO Asset Diagnostics ---"
          echo "$JSON_RESPONSE" | jq '.assets[] | {name: .name, url: .browser_download_url}'
          echo "-------------------------------------"
          
          # 策略：查找所有以 ".tar" 结尾的附件，并取第一个 URL。
          RURIMA_LATEST_URL=$(echo "$JSON_RESPONSE" | \
            jq -r '.assets[] | select(.name | endswith(".tar")) | .browser_download_url' | head -n 1)
          
          if [ -z "$RURIMA_LATEST_URL" ]; then
            echo "::error title=Rurima-AIO Asset Not Found::Could not find a .tar asset in the latest RuriOSS/rurima-aio release."
            echo "Action Failed. Please check the logs above to confirm the correct file extension."
            exit 1
          fi
          
          echo "Found URL: $RURIMA_LATEST_URL"
          echo "RURIMA_LATEST_URL=$RURIMA_LATEST_URL" >> $GITHUB_OUTPUT
          
          # 下载文件，并保存为 .tar 格式
          wget -O rurima-aio.tar "$RURIMA_LATEST_URL"

      - name: 5. Prepare Module Structure (Extract Tarball)
        run: |
          # 1. 创建模块集成目录
          mkdir linker_mod
          
          # 2. 使用 tar 命令解压文件到 linker_mod
          # --strip-components=1 用于移除 tarball 顶层目录，直接提取内容。
          tar -xf rurima-aio.tar -C linker_mod --strip-components=1
          
          # 3. 替换模块 ID (重要)
          sed -i 's/^id=.*/id=linker_rurima/g' linker_mod/module.prop

      - name: 6. Integrate Linker Binary and Wrapper Script
        run: |
          MODULE_BIN_DIR="linker_mod/system/bin"
          WRAPPER_FILE="$MODULE_BIN_DIR/linker-wrapper"
          
          cp linker_output/linker "$MODULE_BIN_DIR/"
          
          printf '#!/system/bin/sh\n' > "$WRAPPER_FILE"
          printf '# 包装器确保 linker 在 rurima 兼容层中运行\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'RURIMA_BIN="/system/bin/rurima"\n' >> "$WRAPPER_FILE"
          printf 'LINKER_BIN="/system/bin/linker"\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'if [ -x "$RURIMA_BIN" ]; then\n' >> "$WRAPPER_FILE"
          printf '    exec "$RURIMA_BIN" "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'else\n' >> "$WRAPPER_FILE"
          printf '    exec "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'fi\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'exit 0\n' >> "$WRAPPER_FILE"
          
          chmod 755 "$WRAPPER_FILE"
          
      - name: 7. Finalize and Zip Module
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
          fi
          
          echo "Building module version: $VERSION"
          
          # 压缩最终的 Magisk 模块 (仍然使用 ZIP 格式用于 Magisk 安装)
          cd linker_mod
          zip -qr ../linker_magisk_mod-${VERSION}.zip .
          cd ..
          
      - name: 8. Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('manual-{0}', github.event.inputs.version) || github.ref }}
          files: linker_magisk_mod-*.zip
          prerelease: false
          body: |
            ## Linker Magisk 模块 ${{ github.event_name == 'workflow_dispatch' && format('Manual Build v{0}', github.event.inputs.version) || format('Release v{0}', github.ref_name) }}
            
            此模块包含以下组件：
            - **核心程序:** Linker (自包含 .NET 8.0/linux-arm64)
            - **兼容层:** 基于最新的 RuriOSS/rurima-aio Magisk 模块。
            
            **用法:** 重启后，在任何 Shell (ADB 或 Termux su) 中运行 `linker-wrapper`。
