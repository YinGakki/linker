# 工作流名称：Magisk 模块自动发布 (Linker + Rurima-AIO 集成)
name: Magisk Module Build and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version (e.g., v1.0.0) - REQUIRED for manual runs.'
        required: true
        default: 'v-manual-build'

jobs:
  build_module:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
        
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: 3. Compile Linker (Self-Contained Single File for ARM64)
        run: |
          dotnet publish src/linker \
            -c Release \
            -f net8.0 \
            -r linux-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o ./linker_output
            
      - name: 4. Download Latest Rurima-AIO Template (FINAL FIX)
        id: get_rurima_release
        run: |
          echo "Fetching latest Rurima-AIO release URL..."
          
          # 策略：只查找所有以 ".zip" 结尾的附件，并取第一个。
          RURIMA_LATEST_URL=$(curl -sfL https://api.github.com/repos/RuriOSS/rurima-aio/releases/latest | \
            jq -r '.assets[] | select(.name | endswith(".zip")) | .browser_download_url' | head -n 1)
          
          if [ -z "$RURIMA_LATEST_URL" ]; then
            echo "::error title=Rurima-AIO Asset Not Found::Could not find a .zip asset in the latest RuriOSS/rurima-aio release."
            echo "Please check the release page manually to verify the asset name and URL."
            exit 1
          fi
          
          echo "Found URL: $RURIMA_LATEST_URL"
          echo "RURIMA_LATEST_URL=$RURIMA_LATEST_URL" >> $GITHUB_OUTPUT
          wget -O rurima-aio.zip "$RURIMA_LATEST_URL"

      - name: 5. Prepare Module Structure (Unzip Template)
        run: |
          unzip rurima-aio.zip -d module_template
          
          MODULE_ROOT_DIR=$(ls module_template | head -n 1)
          MODULE_PATH="module_template/$MODULE_ROOT_DIR"
          
          mkdir linker_mod
          mv "$MODULE_PATH"/* linker_mod/
          
          sed -i 's/^id=.*/id=linker_rurima/g' linker_mod/module.prop

      - name: 6. Integrate Linker Binary and Wrapper Script
        run: |
          MODULE_BIN_DIR="linker_mod/system/bin"
          WRAPPER_FILE="$MODULE_BIN_DIR/linker-wrapper"
          
          cp linker_output/linker "$MODULE_BIN_DIR/"
          
          # 使用 printf 创建脚本
          printf '#!/system/bin/sh\n' > "$WRAPPER_FILE"
          printf '# 包装器确保 linker 在 rurima 兼容层中运行\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'RURIMA_BIN="/system/bin/rurima"\n' >> "$WRAPPER_FILE"
          printf 'LINKER_BIN="/system/bin/linker"\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'if [ -x "$RURIMA_BIN" ]; then\n' >> "$WRAPPER_FILE"
          printf '    exec "$RURIMA_BIN" "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'else\n' >> "$WRAPPER_FILE"
          printf '    exec "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'fi\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'exit 0\n' >> "$WRAPPER_FILE"
          
          chmod 755 "$WRAPPER_FILE"
          
      - name: 7. Finalize and Zip Module
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
          fi
          
          echo "Building module version: $VERSION"
          
          cd linker_mod
          zip -qr ../linker_magisk_mod-${VERSION}.zip .
          cd ..
          
      - name: 8. Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('manual-{0}', github.event.inputs.version) || github.ref }}
          files: linker_magisk_mod-*.zip
          prerelease: false
          body: |
            ## Linker Magisk 模块 ${{ github.event_name == 'workflow_dispatch' && format('Manual Build v{0}', github.event.inputs.version) || format('Release v{0}', github.ref_name) }}
            
            此模块包含以下组件：
            - **核心程序:** Linker (自包含 .NET 8.0/linux-arm64)
            - **兼容层:** 基于最新的 RuriOSS/rurima-aio Magisk 模块。
            
            **用法:** 重启后，在任何 Shell (ADB 或 Termux su) 中运行 `linker-wrapper`。
