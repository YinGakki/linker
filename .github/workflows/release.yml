# 工作流名称：Magisk 模块自动发布 (Linker + Rurima-AIO 集成)
name: Magisk Module Build and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Module version (e.g., v1.0.0) - REQUIRED for manual runs.'
        required: true
        default: 'v-manual-build'

jobs:
  build_module:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash
        
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: 3. Compile Linker (Self-Contained Single File for ARM64)
        run: |
          # 编译 Linker
          dotnet publish src/linker \
            -c Release \
            -f net8.0 \
            -r linux-arm64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o ./linker_output
            
      # --- 移除步骤 4: 不再下载 Rurima 模板 ---

      - name: 5. Create Magisk Module Structure and Files (NEW)
        run: |
          MODULE_DIR="linker_mod"
          
          # 创建基本目录结构
          mkdir -p $MODULE_DIR/system/bin
          
          # 创建 module.prop 文件
          cat > $MODULE_DIR/module.prop << 'EOF'
id=linker_rurima
name=Linker Runner Module
versionCode=1
author=YourName
description=Runs the Linker binary via the Rurima-AIO environment.
EOF
          
          # 创建空的 customize.sh (Magisk 模块需要此文件)
          touch $MODULE_DIR/customize.sh
          
          # 提取当前 Tag 作为版本号，并更新 module.prop
          VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
          sed -i "s/^versionCode=.*/versionCode=$(date +%s)/g" $MODULE_DIR/module.prop
          sed -i "s/^version=.*/version=$VERSION/g" $MODULE_DIR/module.prop

      - name: 6. Integrate Linker Binary and Wrapper Script
        run: |
          MODULE_BIN_DIR="linker_mod/system/bin"
          WRAPPER_FILE="$MODULE_BIN_DIR/linker-wrapper"
          LINKER_BIN_NAME="linker" # 原始 Linker 名称
          
          # A. 移动 Linker 二进制文件到系统路径
          cp linker_output/$LINKER_BIN_NAME "$MODULE_BIN_DIR/$LINKER_BIN_NAME"
          
          # B. 使用 printf 创建 Linker 启动包装器脚本
          printf '#!/system/bin/sh\n' > "$WRAPPER_FILE"
          printf '# 包装器确保 linker 在 rurima 兼容层中运行\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'RURIMA_BIN="/system/bin/rurima"\n' >> "$WRAPPER_FILE"
          printf 'LINKER_BIN="/system/bin/%s"\n' "$LINKER_BIN_NAME" >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'if [ -x "$RURIMA_BIN" ]; then\n' >> "$WRAPPER_FILE"
          printf '    # 使用 rurima 启动 linker，并传递所有参数\n' >> "$WRAPPER_FILE"
          printf '    exec "$RURIMA_BIN" "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'else\n' >> "$WRAPPER_FILE"
          printf '    # 警告：如果 rurima 不可用，直接执行将失败 (ABI 冲突)\n' >> "$WRAPPER_FILE"
          printf '    exec "$LINKER_BIN" "$@"\n' >> "$WRAPPER_FILE"
          printf 'fi\n' >> "$WRAPPER_FILE"
          printf '\n' >> "$WRAPPER_FILE"
          printf 'exit 0\n' >> "$WRAPPER_FILE"
          
          # C. 赋予 wrapper 脚本执行权限
          chmod 755 "$WRAPPER_FILE"
          chmod 755 "$MODULE_BIN_DIR/$LINKER_BIN_NAME"
          
      - name: 7. Finalize and Zip Module
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(echo ${{ github.ref }} | sed 's/refs\/tags\///g')
          fi
          
          echo "Building module version: $VERSION"
          
          cd linker_mod
          zip -qr ../linker_magisk_mod-${VERSION}.zip .
          cd ..
          
      - name: 8. Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('manual-{0}', github.event.inputs.version) || github.ref }}
          files: linker_magisk_mod-*.zip
          prerelease: false
          body: |
            ## Linker Magisk 模块 ${{ github.event_name == 'workflow_dispatch' && format('Manual Build v{0}', github.event.inputs.version) || format('Release v{0}', github.ref_name) }}
            
            此模块是一个 Linker 程序的封装，依赖于设备上已安装的 RuriOSS/rurima-aio 模块。
            
            - **核心程序:** Linker (自包含 .NET 8.0/linux-arm64)
            - **依赖:** RuriOSS/rurima-aio (需单独安装)
            
            **用法:** 重启后，在任何 Shell (ADB 或 Termux su) 中运行 `linker-wrapper`。
