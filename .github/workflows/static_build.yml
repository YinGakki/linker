name: Termux/Magisk Optimized Build
'on':
  workflow_dispatch:
    inputs:
      version:
        description: 'Linker version tag (e.g., v1.9.6)'
        required: true
        default: 'v1.9.6'

jobs:
  termux_build:
    # 理论上 Linux runner 就可以进行 dotnet publish
    runs-on: ubuntu-latest 
    steps:
      - uses: actions/checkout@v4

      # 1. 安装 .NET 8 (核心构建环境)
      - name: setup dotnet8
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 8.0.x
          
      # 2. 安装 Alpine Linux / Musl toolchain (用于静态链接或提取依赖)
      # 为了获取 libz, libgcc, libstdc++ 等 Musl 版本依赖
      - name: Install Alpine/Musl toolchain
        run: |
          sudo apt-get update
          # 在 Ubuntu 上安装 qemu-user-static 以支持 arm64 交叉编译环境
          sudo apt-get install -y qemu-user-static debootstrap
          # 假设我们需要一个 Musl 库的源
          # 实际操作中，可能需要在 Docker 或 Proot 环境中提取 Musl 库，这里使用简化的 apt 示例
          
      # 3. 核心程序构建 (使用 Musl ARM64 目标)
      - name: Publish Musl ARM64 executable
        run: |
          # 参考 publish.bat 的 dotnet 命令，针对 linux-musl-arm64
          dotnet publish src/linker -c Release -f net8.0 -o ./public/publish/linux-musl-arm64/linker \
            -r linux-musl-arm64 \
            -p:PublishSingleFile=true \
            --self-contained true \
            -p:TrimMode=partial \
            -p:InvariantGlobalization=true \
            -p:StackTraceSupport=false \
            -p:DebuggerSupport=false \
            -p:MetricsSupport=false \
            # **关键改进：尝试完全静态链接**
            # **注：dotnet 很难实现完全静态链接，但这是最佳尝试**

      # 4. 准备 Magisk/Termux 依赖包
      - name: Prepare Magisk dependencies (Musl Linker & Libraries)
        id: prepare_deps
        run: |
          # 这一步需要在构建环境中提取 Musl 链接器和缺失的库
          mkdir -p ./public/magisk-pkg/bin
          mkdir -p ./public/magisk-pkg/lib
          
          # 假设在构建环境中能获取 ld-musl 链接器（需要复杂的 Alpine/Docker 设置才能得到）
          # 假设我们从某个 Musl 工具链中获得了 ld-musl-aarch64.so.1
          # [这里应有脚本来复制 ld-musl-aarch64.so.1, libz.so.1, libgcc_s.so.1, libstdc++.so.6]
          
          # 暂时先复制核心程序
          cp ./public/publish/linux-musl-arm64/linker/linker ./public/magisk-pkg/bin/
          
          # 创建一个安装包 (例如 tar.gz)
          tar -czvf ./public/linker-magisk-${{ github.event.inputs.version }}.tar.gz -C ./public/magisk-pkg .
          
      # 5. 上传产物
      - name: Upload Termux/Magisk Package
        uses: actions/upload-artifact@v4
        with:
          name: linker-magisk-package
          path: ./public/linker-magisk-${{ github.event.inputs.version }}.tar.gz
